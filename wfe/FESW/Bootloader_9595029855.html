<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : Bootloader</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Common-all-Documentation_9569468768.html">Common-all Documentation</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : Bootloader
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Former user</span>, last modified by <span class='editor'> rerler@uwaterloo.ca</span> on Sep 10, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><span>This feature is currently not implemented on our current running code.</span></p><p><br/></p><p><span>This page is for the custom bootloader loaded on top of the one built into the board.  It is based on and uses code from <a class="external-link" href="https://www.feaser.com/openblt/doku.php" rel="nofollow"> OpenBLT</a> by Feaser. The goal of this bootloader is so that we can load code to the boards from the beaglebone over CAN and not have to take apart the car to get to the board to load code.  Most of the code specific to the car is with the adaption of the code to our boards and settings, with the project located <a class="external-link" href="https://bitbucket.org/waterloohybrid/openblt/src/master/" rel="nofollow">here</a>.  The code in charge of splitting up the loaded code and sending it over CAN is in the <a class="external-link" href="https://github.com/feaser/openblt" rel="nofollow">OpenBLT repo</a>.<br/></span></p><p><span>The bootloader is a program that sits in the first 10k to 32k of memory. All programs loaded onto the bootloader have their linker script modified to have their memory start where the bootloader ends (10k to 32k bytes from the start of memory, depending on the board).  When the board is powered up and the bootloader is started, the bootloader waits 500ms to check for incoming CAN signals from the python script and if none are found then it loads and runs the program currently in flash.  If no program is found then it waits for a CAN message.  When it receives a CAN message from the python script then it loads the program being sent into flash and then passes control to the program.  The bootloader doesn’t monitor the CAN bus when the loaded program is running, so in order for new code to be loaded on the board needs to be restarted, although an interrupt can be added to program code to automatically restart the board when the bootloader CAN signal is detected.  The bootloader also takes up the first 192 bytes of RAM that it uses for vector tables.<br/></span></p><p><br/></p><p><span>The python script, located inside of common-all/scripts, runs on the Beaglebone and uses the project board name to figure out the CAN address of the board that it should be sending to.  It then loads an SREC file (if one doesn't exist then it makes one) and repeatedly sends out messages on the CAN bus until the bootloader responds.  Once it gets a response, it sends the SREC over the CAN bus to the bootloader on the target board.</span></p><p><br/></p><p><span>In order to ensure that the bootloader is always present on the board, an additional command was added to common-all called usb_load where instead of just loading the program binary, the bootloader is loaded first and then the program is loaded on top of it using RS-232.</span></p><p><br/></p><p>Board Types:</p><p>Bootloaders have been made for F072 and F767.  The version for F072 uses the first 10k of RAM and runs on can1.  The version for F767 uses the first 32k of flash and runs on can3.  There are no differences in the python script between sending to different board types.</p><p><br/></p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 02:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
