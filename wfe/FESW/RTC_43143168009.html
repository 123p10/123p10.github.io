<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : RTC</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Board-Specific-Documentation_9567701653.html">Board Specific Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Beaglebone_9595029852.html">Beaglebone</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : RTC
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Justin Vuong</span>, last modified by <span class='editor'> Ryan Erler</span> on Jul 25, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="RTC-Overview">Overview</h2><p>The Beaglebone is running a linux kernel and therefore has an internal system clock, but since it doesn't have an internal battery for it, it gets reset whenever the beaglebone powercycles.  Therefore, an external Real Time Clock, or RTC, was added to the beaglebone to sync up with the internal clock on boot.  The RTC is soldered onto the beaglebone and communicates via i2c. </p><h2 id="RTC-SettinguptheRTC">Setting up the RTC</h2><p>The RTC we are currently using is DS1307.  IT is a cheap and common breakboard meant for this exact purpose.  It runs off either the beaglebone power if it is on, or a battery on the breakout board.  The battery is a 3V coin battery (e.g. CR1220).</p><p>It is currently mounted on the beaglebone by soldering it to the corresponding pins.  It is on the i2c header number 2 with ID 68. It can be detected via terminal with  <code>i2cdetect -y -r 2</code> where it should eitehr show as a <code>68</code> or <code>UU</code> depending on whether or not its in use (i.e. mounted by the system). </p><p>To mount the RTC, run <code>echo ds1307 0x68 &gt; /sys/class/i2c-adapter/i2c-2/new_device</code>.  This command tells the system that theres a new device on the i2c adapter 2 with an ID of 68 called ds1307.  Note that this command must be run as root and many not work if the user uses sudo instead. Once run, you can read the RTC by running <code>hwclock -r -f /dev/rtc1</code>.  To write the system time to the RTC, run <code>hwclock -w -f /dev/rtc1</code>, and to write the RTC time to the system time run <code>hwclock -s -f /dev/rtc1</code>.</p><h2 id="RTC-CurrentRTCUsage">Current RTC Usage</h2><p>In order to make sure the system time is correct, it needs to sync up to the RTC time on bootup.  This done by adding a service to the beaglebone that on boot calls a bash script to sync them up.  The service is called <code>rtc-ds1307</code> and the details for it are in <code>/lib/systemd/system/rtc-ds1307.service</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[Unit]
Description=DS1307 RTC Service

[Service]
Type=simple
WorkingDirectory=/usr/share/rtc_ds1307
ExecStart=/bin/bash clock_init.sh
SyslogIdentifier=rtc_ds1307

[Install]
WantedBy=multi-user.target</pre>
</div></div><p /><p>The bash script, located <code>/usr/share/rtc_ds1307/clock_init.sh</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">#!/bin/bash
sleep 15
echo ds1307 0x68 &gt; /sys/class/i2c-adapter/i2c-2/new_device
hwclock -s -f /dev/rtc1</pre>
</div></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 02:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
