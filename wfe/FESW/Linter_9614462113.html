<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : Linter</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Common-all-Documentation_9569468768.html">Common-all Documentation</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : Linter
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> zzakiull@uwaterloo.ca</span>, last modified by <span class='editor'> Justin Vuong</span> on Oct 05, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>This document contains the following:</p><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1665802300076 {padding: 0px;}
div.rbtoc1665802300076 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1665802300076 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1665802300076'>
<ul class='toc-indentation'>
<li><a href='#Linter-InstallingCppcheckonMac'>Installing Cppcheck on Mac</a></li>
<li><a href='#Linter-InstallingCppcheckonLinux'>Installing Cppcheck on Linux</a></li>
<li><a href='#Linter-RunningtheLinter'>Running the Linter</a>
<ul class='toc-indentation'>
<li><a href='#Linter-MISRA-CRules'>MISRA-C Rules</a></li>
<li><a href='#Linter-SuppressingIssues'>Suppressing Issues</a>
<ul class='toc-indentation'>
<li><a href='#Linter-SuppressingbyMISRA-CRuleNumber'>Suppressing by MISRA-C Rule Number</a></li>
<li><a href='#Linter-InlineSuppressions'>Inline Suppressions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href='#Linter-OtherNotes'>Other Notes</a></li>
<li><a href='#Linter-CompletingLinterTasks'>Completing Linter Tasks</a></li>
<li><a href='#Linter-FurtherReferences'>Further References</a></li>
</ul>
</div></p><h1 id="Linter-InstallingCppcheckonMac">Installing Cppcheck on Mac</h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">brew install cppcheck</pre>
</div></div><h1 id="Linter-InstallingCppcheckonLinux">Installing Cppcheck on Linux</h1><p>First, install PCRE:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sudo apt-get install libpcre3 libpcre3-dev </pre>
</div></div><p>Then, you can either download Cppcheck from <a class="external-link" href="https://github.com/danmar/cppcheck/releases/latest" rel="nofollow">here</a> or clone the repo:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">git clone git@github.com:danmar/cppcheck.git
cd cppcheck</pre>
</div></div><p>Run make to install Cppcheck:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sudo make MATCHCOMPILER=yes FILESDIR=/usr/share/cppcheck CFGDIR=/usr/bin/cfg HAVE_RULES=yes CXXFLAGS=&quot;-O2 -DNDEBUG -Wall -Wno-sign-compare -Wno-unused-function&quot; install</pre>
</div></div><p><span style="color: rgb(23,43,77);">To check if cppcheck is installed, run:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">cppcheck --version </pre>
</div></div><p><span class="auto-cursor-target" style="color: rgb(23,43,77);"><span style="color: rgb(23,43,77);">As of when this was written, the latest version is 2.6.</span></span></p><h1 id="Linter-RunningtheLinter">Running the Linter</h1><p>Before running the linter, you will first need to clone the firmware repo:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">git clone git@bitbucket.org:waterloohybrid/firmware.git
cd firmware</pre>
</div></div><p>You have the option to run the linter on all boards, or just a specific board. To run on all boards (and common-all), run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">make lint</pre>
</div></div><p>This will create a Lint/ directory that will contain a log file for common-all and each board.</p><p>Alternatively, you can pass in the argument LINT_TARGET to specify only one target for the linter to check. The example below would run the linter for the BMU code only:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">make lint LINT_TARGET=bmu</pre>
</div></div><p>All valid options for the LINT_TARGET argument are listed below:</p><ul><li>bmu</li><li>common</li><li>dcu</li><li>pdu</li><li>vcu</li><li>wsb</li></ul><p>If an invalid argument for LINT_TARGET is passed in, then the linter will run on all targets.</p><h2 id="Linter-MISRA-CRules">MISRA-C Rules</h2><p>The linter is currently configured to check if our code conforms to the MISRA-C 2012 rules as well. When we run Cppcheck, we pass in a rule text file (located in firmware/common/Misra/misra.txt) that lists the rule numbers and rule text, which Cppcheck uses to list what rule is being violated. Without this rule text, the log files generated would only list the MISRA rule number and not the actual rule text. The rule text is in the format shown below:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>misra.txt</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Appendix A Summary of guidelines
Rule 1.1
The program shall contain no violations of the standard C syntax and constraints, and shall not exceed the implementation&#39;s translation limits. 
Rule 1.2
Language extensions should not be used.
Rule 1.3
There shall be no occurrence of undefined or critical unspecified behavior.
[...]</pre>
</div></div><h2 id="Linter-SuppressingIssues">Suppressing Issues</h2><h3 id="Linter-SuppressingbyMISRA-CRuleNumber">Suppressing by MISRA-C Rule Number</h3><p>To suppress particular MISRA-C rules, the rule needs to be added to <code>firmware/common/Misra/misra.json</code> shown below, to the list of rules passed in the argument <code>--suppress-rules</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>misra.json</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false; theme: Confluence" data-theme="Confluence">{
    &quot;script&quot;: &quot;misra.py&quot;,
    &quot;args&quot;: [
        &quot;--rule-texts=./common/Misra/misra.txt&quot;
        &quot;--rule-texts=./common/Misra/misra.txt&quot;,
        &quot;--suppress-rules=2.7,3.1,7.2,7.4,8.2,15.4,15.5,15.7,17.7,17.8,18.4,18.8,20.10&quot;
    ]
}</pre>
</div></div><p>For example, if we wanted to also suppress Rule 1.1, the <code>--suppress-rules</code> line would then look like:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>--suppress-rules argument from misra.json</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false; theme: Confluence" data-theme="Confluence">&quot;--suppress-rules=1.1,2.7,3.1,7.2,7.4,8.2,15.4,15.5,15.7,17.7,17.8,18.4,18.8,20.10&quot;</pre>
</div></div><p>It's preferred that the suppressed rules are listed in numerical order.</p><h3 id="Linter-InlineSuppressions">Inline Suppressions</h3><p>To add an inline suppression, you will need to add a comment right above the line that's causing the lint error. For example, if we wanted to suppress the lint error <code>unusedFunction</code> for a particular function, then we would do it like this:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Inline suppression example</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: cpp; gutter: false; theme: Confluence" data-theme="Confluence">// cppcheck-suppress unusedFunction
int some_function_not_used(void) {
	printf(&quot;I&#39;m useless\n&quot;);
}</pre>
</div></div><p>If we want to suppress a lint error that's a MISRA violation, the comment would look something like this:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Inline suppression with MISRA example</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: cpp; gutter: false; theme: Confluence" data-theme="Confluence">// cppcheck-suppress misra-c2012-2.7
void misra_2_7_unused_param (int *param1, int unused_param) {
    *param1 = 42U;
}</pre>
</div></div><p>We use inline suppressions when we want to suppress only a few issues of a certain type. If we want to suppress all issues of a certain type, then we would add it to either <code>misra.json</code> (for MISRA-C issues) or the cppcheck command in <code>tail.mk</code> (for non-MISRA-C issues).</p><h1 id="Linter-OtherNotes">Other Notes</h1><p><a class="external-link" href="https://jira.uwaterloo.ca/browse/WFE-1441" rel="nofollow">WFE-1441</a> and <a class="external-link" href="https://jira.uwaterloo.ca/browse/WFE-1442" rel="nofollow">WFE-1442</a> were created to investigating adding all STM include directories to the linter as well. A suppressions.txt file would also be created so the linter would not actually run on all these files. The purpose of adding them would allow the linter to recognize STM function calls in our own code (when it can't find a function declaration, it will bring this issue up). However, these 2 tickets were cancelled as adding all include directories affected the speed at which the linter ran. Without having to check all STM include directories, the linter normally takes less than a minute to run. However, when checking all STM include directories, it can take up to 5 minutes. This isn't really feasible if we want to later run the linter automatically on Bitbucket Pipelines, so until we find a better way to do this, these tasks have been cancelled for now.</p><p><br/></p><h1 id="Linter-CompletingLinterTasks">Completing Linter Tasks</h1><ul style="list-style-type: square;"><li>You will be assigned a board (bmu/pdu/vcu/wsb/dcu) and a rule. You can determine these two things based on the Jira ticket that is assigned to you. For this example, I will use the BMU and rule 10.1 so anywhere you see bmu replace it by your board name. </li><li><p class="auto-cursor-target">The first thing you need to do is run</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">make lint LINT_TARGET=bmu</pre>
</div></div><p class="auto-cursor-target">This will create the Lint/bmu-lint.log file so open that up and search for your rule number</p></li><li><p class="auto-cursor-target">In my case I found it the following match [misra-c2012-<strong>10.1</strong>]. The entire line is shown below</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">bmu/Src/F7_Src/ade7912.c:124:31: style: Operands shall not be of an inappropriate essential type. [misra-c2012-10.1]
  data |= (int32_t)rbuffer[1] &lt;&lt; 24;

</pre>
</div></div></li><li><p class="auto-cursor-target"> Looking at the first part of the line you will see bmu/Src/F7_Src/ade7912.c:124 which indicates that you need to change the file bmu/Src/F7_Src/ade7912.c on line 124. </p></li><li>Do some research to understand what that violation is associated with your MISRA C rule and make the adjustment in the code</li><li>After making the change run make lint bmu again and if that instance of the violation has disappeared you successfully fixed the violation. Continue to search the bmu-lint.log for other instances of your rule and address those as well until there are no more references to your rule</li><li><p class="auto-cursor-target">Make sure that your code still compiles by running</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">make bmu</pre>
</div></div><p class="auto-cursor-target">If you get the following output then there are no compile errors then you can push your code and you are done. Otherwise if errors come up address them and continue to run make bmu until you get the output below</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">jvuong@jvuong-VirtualBox:~/Desktop/WFE/firmware$ make bmu
-e Building Board: bmu 
   text	   data	    bss	    dec	    hex	filename
 132492	   5664	 277336	 415492	  65704	Bin/bmu/Release/bmu.elf
-e Completed Build bmu</pre>
</div></div></li></ul><ul><li>Congrats you have finished your first firmware task!</li></ul><h1 id="Linter-FurtherReferences">Further References</h1><p>For further reference, you can look at these links:</p><ul><li><a class="external-link" href="https://github.com/danmar/cppcheck" rel="nofollow">Cppcheck GitHub</a></li><li><a class="external-link" href="https://cppcheck.sourceforge.io/manual.pdf" rel="nofollow">Cppcheck Manual</a></li><li><a class="external-link" href="https://www.misra.org.uk/" rel="nofollow">MISRA Website</a></li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 02:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
