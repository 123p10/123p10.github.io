<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : BMU Fan Tachometer</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Board-Specific-Documentation_9567701653.html">Board Specific Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="9528803896.html">BMU (Battery Management Unit)</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : BMU Fan Tachometer
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Justin Vuong</span>, last modified by <span class='editor'> Jacky Lim</span> on Sep 26, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="BMUFanTachometer-Introduction">Introduction</h2><p>All 3-wire fans will have a tachometer. A <strong>tachometer </strong>allows the users to monitor the speed of the fans and to utilize this hardware, we will need to develop the circuitry to read the signal generated by the tachometer.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/43146838312/43208736901.png" data-image-src="attachments/43146838312/43208736901.png" data-height="450" data-width="450" data-unresolved-comment-count="0" data-linked-resource-id="43208736901" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220913-195527.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="43146838312" data-linked-resource-container-version="3" data-media-id="4e49adbf-55f3-4f95-a9fd-6d6cfffa6030" data-media-type="file"></span><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Generally, the tachometer is attached to the yellow wire.</p></div></div><h2 id="BMUFanTachometer-Tachometer">Tachometer</h2><p>A tachometer relies on the principle of the Hall effect. To learn more about the Hall effect, please refer to <a href="https://uwaterloo.atlassian.net/wiki/spaces/FEAM/pages/42909565459/Accumulator+Current+Sense" data-linked-resource-id="42909565459" data-linked-resource-version="7" data-linked-resource-type="page">this page</a>. In short, there is a Hall-effect sensor mounted on the motor driver printed circuit board (PCB) and there is a magnet in the rotating rotor which activates the sensor. The emitted signal from the tachometer is a square wave.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/43146838312/43212144841.png" data-image-src="attachments/43146838312/43212144841.png" data-height="171" data-width="295" data-unresolved-comment-count="0" data-linked-resource-id="43212144841" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220914-204334.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="43146838312" data-linked-resource-container-version="3" data-media-id="f31878f2-4fd2-4da1-8e13-0d492865c32d" data-media-type="file"></span><p>For most fans, two pulses are generated for each revolution. Otherwise, it would be one pulse per revolution. The number of pulses counted in a minute is directly proportional to the revolutions-per-minute (RPM) of the fan. </p><p>The <a class="external-link" href="https://www.mouser.ca/ProductDetail/Sanyo-Denki/9GA0812P4J001?qs=JgUGn%2FCSypwJIhJpeg4%252BFw%3D%3D" rel="nofollow">DC fans</a> we are using in the battery management unit (BMU) produce two pulses per revolution. Thus, the RPM of a fan can be calculated using the formula below:</p><p /><p style="text-align: center;"><strong>RPM = (freq/2) * 60</strong></p><h2 id="BMUFanTachometer-STM32InputCapture">STM32 Input Capture</h2><p>There are <strong>five fans</strong> responsible for cooling the BMU and the emitted tachometer signals are connected to pins <strong>PC6 </strong>and <strong>PD12-15</strong> on our <a class="external-link" href="https://www.mouser.ca/datasheet/2/389/stm32f765bi-2956130.pdf" rel="nofollow">STM32 microcontroller</a>. </p><p>To program an STM32 microcontroller, we can utilize <a class="external-link" href="https://www.st.com/en/development-tools/stm32cubemx.html" rel="nofollow">STM32CubeMX</a> which is a GUI that enables us to configure our chip. By selecting what we want the pins to do and their parameters, this program will subsequentially write the code for us. <a class="external-link" href="https://www.st.com/en/development-tools/stm32cubeide.html" rel="nofollow">STM32CubeIDE</a> is a more complete package that allows code compilation and debugging in addition to all the functionalities found in STM32CubeMX. Both of these tools are available on Linux. </p><p>A common way to read a signal is using <strong>interrupts</strong>. For our case, we are triggering an interrupt to read the signal from the tachometer. Then using one of the hardware timers on the STM32, the callback function will be used to read the signal. This callback function will capture the rising edges and determine the frequency by measuring the pulse width. With frequency, the RPM of the fan can be calculated using the formula shown earlier.</p><p>In total, there are 18 timers on our STM32 with most of them being general-purpose timers. Each timer comes with 4 independent channels that can output a signal or capture an input. Read <a class="external-link" href="https://www.mouser.ca/datasheet/2/389/stm32f765bi-2956130.pdf" rel="nofollow">pg 40</a> for more information on timers. </p><div class="table-wrap"><table data-layout="default" data-local-id="4d3af42d-ff3c-48db-807a-73f965a6ac4f" class="confluenceTable"><colgroup><col style="width: 170.0px;"/><col style="width: 170.0px;"/><col style="width: 170.0px;"/><col style="width: 170.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Pins</strong></p></th><th class="confluenceTh"><p><strong>Timer</strong></p></th><th class="confluenceTh"><p><strong>Channel</strong></p></th><th class="confluenceTh"><p><strong>APB</strong></p></th></tr><tr><td class="confluenceTd"><p>PC6</p></td><td class="confluenceTd"><p>Timer 8 (16 bit)</p></td><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>2 </p></td></tr><tr><td class="confluenceTd"><p>PD12-15</p></td><td class="confluenceTd"><p>Timer 4 (16 bit)</p></td><td class="confluenceTd"><p>1-4</p></td><td class="confluenceTd"><p>1 </p></td></tr></tbody></table></div><p>Every timer is connected to an advanced peripheral bus (APB). The frequency at which a timer operates at depends on the APB’s frequency. To determine which bus a timer is connected to and APB’s frequency, refer to the <a class="external-link" href="https://www.mouser.ca/datasheet/2/389/stm32f765bi-2956130.pdf#page=20" rel="nofollow">block diagram</a> on the datasheet. To adjust the frequency of a timer, a prescaler is applied and the formula below can be used. </p><p /><p style="text-align: center;"><strong>Timer Frequency = APB Frequency / Prescaler</strong></p><p style="text-align: center;" /><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>The prescaler and ARR registers are setup in a way such that they automatically add 1 to the value. Thus if you want it at ‘16’, your input would be ‘16-1’.</p></div></div><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="448" loading="lazy" src="attachments/43146838312/43212538208.png?width=448" data-image-src="attachments/43146838312/43212538208.png" data-height="398" data-width="320" data-unresolved-comment-count="0" data-linked-resource-id="43212538208" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220914-231611.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="43146838312" data-linked-resource-container-version="3" data-media-id="35459794-91bc-4053-a0cd-19c503f8a2c8" data-media-type="file"></span><h3 id="BMUFanTachometer-Steps:">Steps:</h3><ol><li><p>Initialize the hardware timers in <em>Input Capture</em> mode.</p></li><li><p>Select the right parameters for each timer ('Prescalar' &amp; ‘Counter Period’ under parameter settings, and toggle ‘Trigger interrupt’ under NVIC settings).</p><ol><li><p>For the prescalar parameter, it should match the Advanced Peripheral Bus (APB)'s frequency. This will make the timer operate at 1 MHz.</p></li><li><p>The counter period or AutoReload Register (ARR) is the range of the timer. Upon reaching the upper limit, the timer will reset to 0 and vice versa. For a 16-bit timer, the counter period should be 65,535.</p></li><li><p>For the interrupt settings, we want to toggle the ‘trigger interrupt’ option. </p></li></ol></li><li><p>Click ‘Generate Code’ and that is the code that will go into 'fanControl.c' or the appropriate file. </p></li><li><p>Optional: You can program a timer to generate a PWM output signal and utilize that signal to test the timer/pin that is capturing the input. </p></li></ol><p /><p>Most of the information on this page is cited from this highly informative <a class="external-link" href="https://www.youtube.com/watch?v=rh4pdNWKLJY&amp;t=1s" rel="nofollow">video</a>. It is worth watching for a more visual guide. The code from the video can be found in this <a class="external-link" href="https://controllerstech.com/input-capture-in-stm32/" rel="nofollow">article</a>.</p><p />
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/43146838312/43208736901.png">image-20220913-195527.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/43146838312/43212144841.png">image-20220914-204334.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/43146838312/43212538208.png">image-20220914-231611.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 01:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
