<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : UART with STM32</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="9437059818.html">Firmware Documentation Archive (2017-2019)</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : UART with STM32
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> User 9bb23</span>, last modified by <span class='editor'> Former user</span> on May 22, 2018
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><strong>Background: </strong></p><p>UART stands for Universal Asynchronous Receiver/Transmitter, and is a physical circuit in the MCU that transmits or receives <a class="external-link" href="https://wiki.uwaterloo.ca/www.quantil.com/content-delivery-insights/content-acceleration/data-transmission/" rel="nofollow">serial data</a>. If you have worked with Arduino before, this is the protocol that serial.print command uses to communicate between two devices. </p><p><strong>How we use UART: </strong></p><p>UART creates a serial link between the device (STM) and the host (your computer); this is not a master slave relationship. UART is a robust and simple protocol that allows both devices to send data at different times to each other. Generally, UART is used to communicate debugging information, ie structured use of printf(), to a host.</p><p><br/></p><p><strong>Setting up UART with STM:</strong></p><p>Source:<strong> <a class="external-link" href="https://letanphuc.net/2015/09/stm32f0-uart-tutorial-5/" rel="nofollow">https://letanphuc.net/2015/09/stm32f0-uart-tutorial-5/</a></strong></p><p><span style="color: rgb(0,0,255);"><u>Setting up CubeMX</u></span></p><p>1) Open a new project and select the correct MCU model </p><p>2) Follow the steps in the video linked<a class="external-link" href="https://youtu.be/IdKx4oWNJfw" rel="nofollow"> here</a>. This is a step by step tutorial of how to initialize the configuration and transmit/receive data, it will go into receiving and transmitting but there are more instructions on those steps below. </p><p>Below you will find context to some of the more important steps:</p><p><span style="color: rgb(58,65,69);">Baud rate: this parameter decides how fast the communication is. The standard baud rates are: 1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 250000, , 230400, 460800, 921600, 1.5Mbps, 3Mbps… The bigger the number is, the faster your communication is.</span></p><p><span style="color: rgb(58,65,69);">Word length: usually 8bit will do the job, unless you want to do multi-slaves communication then we can use 9bit length. However, multi-slave communication can also be done with 8bit.</span></p><p><br/></p><p><u><span style="color: rgb(0,0,255);">Transmitting Data</span></u></p><p>There are two methods you can use to transmit data - the printf command and using the HAL library.</p><ul style="list-style-type: square;"><li>Using the HAL Library to Transmit Data<br/><span style="letter-spacing: 0.0px;">This requires two steps, converting the string you want to transmit into an array, and then transmitting the array. An example is shown below: </span><br/><pre><code>//print out static text
len=sprintf(buffer,&quot;Hello\r\n&quot;); //sprintf will return the length of 'buffer'  
HAL_UART_Transmit(&amp;huart1, buffer, len, 1000);

//print out variable
len=sprintf(buffer,&quot;This is i:%i\r\n&quot;,i); //sprintf will return the length of 'buffer'  
HAL_UART_Transmit(&amp;huart1, buffer, len, 1000);  </code></pre><pre><code><br/></code></pre></li><li><span style="letter-spacing: 0.0px;">Using the printf command</span><br/>Paste the following code behind #include to configure the function:<br/><pre><code>/* Private function prototypes -----------------------------------------------*/
#ifdef __GNUC__
  /* With GCC/RAISONANCE, small printf (option LD Linker-&gt;Libraries-&gt;Small printf
     set to 'Yes') calls __io_putchar() */
  #define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
  #define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif /* __GNUC__ */

/**
  * @brief  Retargets the C library printf function to the USART.
  * @param  None
  * @retval None
  */
PUTCHAR_PROTOTYPE  
{
    /* Place your implementation of fputc here */
    /* e.g. write a character to the USART */
    HAL_UART_Transmit(&amp;huart1, (uint8_t *)&amp;ch, 1, 100);


    return ch;
}
/* USER CODE END PFP */</code></pre><pre><code><br/></code></pre><p>Now use the printf function anywhere in your main loop to send data to your computer. For example: </p><pre><code>//For sending data out in while(1)
printf(&quot;Hello\r\n&quot;);  
printf(&quot;This is i:%i\r\n&quot;,i);  </code></pre><br/><u><span style="letter-spacing: 0.0px;color: rgb(0,0,255);">Receiving Data Using Interrupt: </span></u><br/><u><span style="letter-spacing: 0.0px;color: rgb(0,0,255);"><br/></span></u><span style="color: rgb(0,0,0);">A common mechanism for receiving data is storing each bite in an array until a CR (carriage return) is received, which is ASCII 13 or enter. After the CR is received a variable is triggered to indicate that the transfer is complete (Reminder: the variable will need to be reset at the end of the session). </span><br/><span style="color: rgb(0,0,0);"><span style="color: rgb(0,0,0);">1) </span></span><span style="text-align: justify;letter-spacing: 0.0px;color: rgb(0,0,0);">activate the UART receive interrupt every time it receives one byte of data: </span><pre><code>HAL_UART_Receive_IT(&amp;huart1, Rx_data, 1);</code></pre><p>where Rx_data is an array that only stores one byte of data. <br/>You will also need another array Rx_Buffer for example that will store each bite of data until the trigger variable is activated. <br/>An example of the code is included below:</p><pre><code>//variables need to be declared at the beginning 
char Rx_indx, Rx_data[2], Rx_Buffer[100], Transfer_cplt;

//Interrupt callback routine
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)  
{
    uint8_t i;
    if (huart-&gt;Instance == USART1)  //current UART
        {
        if (Rx_indx==0) {for (i=0;i&lt;100;i++) Rx_Buffer[i]=0;}   //clear Rx_Buffer before receiving new data 

        if (Rx_data[0]!=13) //if received data different from ascii 13 (enter)
            {
            Rx_Buffer[Rx_indx++]=Rx_data[0];    //add data to Rx_Buffer
            }
        else            //if received data = 13
            {
            Rx_indx=0;
            Transfer_cplt=1;//transfer complete, data is ready to read
            }

        HAL_UART_Receive_IT(&amp;huart1, Rx_data, 1);   //activate UART receive interrupt every time
        }

}</code></pre></li></ul><p><br/></p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 02:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
