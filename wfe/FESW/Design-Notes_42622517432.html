<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : Design Notes</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware-Projects_9571009451.html">Firmware Projects</a></span>
                            </li>
                                                    <li>
                                <span><a href="Endurance-Mode_19415171148.html">Endurance Mode</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : Design Notes
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Justin Vuong</span>, last modified on Apr 05, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="DesignNotes-BackgroundInformation">Background Information</h1><ul><li><p>The accumulator is 294V when fully charged and 260V average</p><ul><li><p>There are 5 segments in series. <span class="inline-comment-marker" data-ref="650a66da-1622-4159-82c7-08b37bd91ebe">Each segment</span> consists of 14 groups in series of 7 parallel cells</p><ul><li><p>Pack Voltage is the sum of all the segments</p></li></ul></li><li><p>Each cell runs at a voltage of 2.5V (discharged) to 4.2V (charged) </p></li><li><p>We can make voltage and current measurements of the pack in code using getPackVoltage() and getIBus() in bmu/batteries.c. It reads from the PackVoltageQueue, occurs every 1ms in HVMeasureTask</p></li><li><p>The cell’s internal resistance is approx 0.18 Ohms</p></li></ul></li><li><p>The car is designed to go up to 130 km/h</p></li><li><p>The endurance track is a 1km loop (New Hampshire Motor Speedway)</p></li><li><p>The car is around 310kg (includes a 80kg driver)</p></li><li><p>The race is to finish 44 laps as fast as possible. We are aiming for 1min laps.</p><ul><li><p>40 mins would be a good time, 50 mins is slow and 1 hour is crawling</p></li><li><p>Based on the power needed for a certain lap time, it's best to go at a consistent pace the entire race which is why we need a controller to help the drivers</p></li><li><p>The motors will use ~6kW for a 60s lap time and ~900W for 100s lap times (not a linear relationship)</p></li></ul></li><li><p>SOC = State of charge</p></li></ul><p /><p>Points calculation for the endurance race</p><p class="media-group"><span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/42622517432/42902454278" data-nice-type="null" data-file-src="/wiki/download/attachments/42622517432/Points%20Calculation?version=1&amp;modificationDate=1643099159185&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="42902454278" data-linked-resource-type="attachment" data-linked-resource-container-id="42622517432" data-linked-resource-default-alias="Points Calculation" data-mime-type="application/octet-stream" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="e0b7ca67-8841-45d4-8432-67becddaa37d" data-media-type="file"><img src="attachments/thumbnails/42622517432/42902454278" height="250"/></a></span></p><h1 id="DesignNotes-Method">Method</h1><ul><li><p>To tune the PI controller values we used the keysight regenerative load bank (RP7935A)</p></li><li><p>A Matlab script was used to simulate lap time data and its interaction with the battery (data below)</p><ul><li><p>Note only one segment was used to testing but we know this will scale well to 5 since they are in parallel and the current drawn would scale given that configuration</p></li><li><p>This was used to tune the controller (Kp, Ki constants) and determine where the cutoff voltages for the method to calculate the SOC lie</p></li></ul></li></ul><p /><p>Resources/Data from the tractive team</p><p><a href="https://uwaterloo.atlassian.net/wiki/pages/viewpageattachments.action?pageId=19415171148" rel="nofollow">https://uwaterloo.atlassian.net/wiki/pages/viewpageattachments.action?pageId=19415171148</a></p><p class="media-group"><span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/42622517432/42902552579.xls" data-nice-type="Microsoft Excel Spreadsheet" data-file-src="/wiki/download/attachments/42622517432/filt_30Q_C5_endurance_sealed_3.12A_2020-09-14_data.xls?version=1&amp;modificationDate=1643099111509&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="42902552579" data-linked-resource-type="attachment" data-linked-resource-container-id="42622517432" data-linked-resource-default-alias="filt_30Q_C5_endurance_sealed_3.12A_2020-09-14_data.xls" data-mime-type="application/vnd.ms-excel" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="3553743f-3877-44d7-b687-63717c1252c6" data-media-type="file"><img src="attachments/thumbnails/42622517432/42902552579" height="250"/></a></span></p><p /><p>The transponder on the car give us a signal about when we complete a lap. More info below:</p><p class="media-group"><span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/42622517432/42911302463.pdf" data-nice-type="PDF Document" data-file-src="/wiki/download/attachments/42622517432/X2%20CAN%20bus%20description.pdf?version=1&amp;modificationDate=1643603176610&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="42911302463" data-linked-resource-type="attachment" data-linked-resource-container-id="42622517432" data-linked-resource-default-alias="X2 CAN bus description.pdf" data-mime-type="application/pdf" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="c0b6f817-22c1-475b-8b6a-8c2529822b32" data-media-type="file"><img src="attachments/thumbnails/42622517432/42911302463" height="250"/></a></span></p><h1 id="DesignNotes-DesignDecisions">Design Decisions</h1><ul><li><p>Since the HV_MEASURE task is running at 1ms we used the same period as we want to update the energy calculation as often as possible without starving other tasks (will monitor to see if this is too demanding)</p></li><li><p>Since we don’t have the infrastructure to calculate actual distance traveled (need to account for slip and not just the rotations of the wheel) we will update the controller once every lap</p></li><li><p>Due to hysteresis, the voltages of a battery close to being full/depleted are very indicative of its state of charge. Therefore, until 56V (4V per cell * 14 cells per group) and once the battery hits 46V (3.3V per cell * 14 cells per group) the voltage of the batteries are used as the best indication of the battery’s state of charge </p><ul><li><p><span class="inline-comment-marker" data-ref="9f6b4b11-5644-48c9-bfe7-90e8d7ed4759">Chose to integrate the amount of energy leaving the battery outside of the ranges 46V-56V since another metric like voltage will fluctuate with temperature which is out of our control at the competition</span></p></li><li><p>When the batteries are in the range of 46V-56V, the current leaving the batteries is integrated (1ms intervals) and used to calculate the state of charge</p></li><li><p>Note the charged/discharged voltages of each cell is 2.5V and 4.2V. The upper limit of the cutoff (4V per cell) is so close since we are assuming that we are going to use endurance mode when the battery is very close to fully charged</p></li><li><p>Formula:</p><ul><li><p>SOC = (a * Mv) + (b * Mi)</p><p>where a and b are the adjusting linear combination constants. Mv is the voltage to SoC map and Mi is the integration SoC method.</p></li><li><p>So beginning we will fully use the voltage to SoC map so a = 1, b = 0. Then as cell voltage drops we will gradually factor in the integration method and fade out the voltage method. Then, a = 0, b = 1. Finally, at low voltages the cell voltage is faded back in until a = 1, b = 0.</p></li><li><p>Graph of the constant b over time:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/42622517432/42905633318.png" data-image-src="attachments/42622517432/42905633318.png" data-height="397" data-width="1097" data-unresolved-comment-count="0" data-linked-resource-id="42905633318" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220127-022348.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="42622517432" data-linked-resource-container-version="28" data-media-id="ed13c2be-97c8-474f-8c6d-62b5b6255e53" data-media-type="file"></span></li></ul></li></ul></li><li><p>We decided to go for a PI controller because it is easy to implement and fits the application</p><ul><li><p>Including a D term could add a significant amount of instability that is not required</p></li></ul></li><li><p>There will be buttons to start/stop (calibrate the algorithm) and toggle the throttle limiting functionality</p></li><li><p>We’re gonna actually just restrict the power based on the SOC and % of the race completed</p><ul><li><p>See sendThrottleValuesToMCs in vcu/motorController.c</p></li><li><p>Our throttle works by modulating torque. But for endurance mode, we are going to put power restrictions on it.<strong> So I guess probably affects CurrentLimit?? That’s something to look into.</strong></p></li><li><p>The speed of the car is controlled by the torque command but it’s capped by the power limit. In pseudocode:<br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sendTorqueValuetoMC(based_on_pedal_throttle);
sendPowerLimitValuetoMC(based_on_endurance_mode);</pre>
</div></div></li></ul></li></ul><h1 id="DesignNotes-PIController">PI Controller</h1><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/42622517432/42902716427.png" data-image-src="attachments/42622517432/42902716427.png" data-height="687" data-width="1023" data-unresolved-comment-count="0" data-linked-resource-id="42902716427" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220125-090113.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="42622517432" data-linked-resource-container-version="28" data-media-id="3c17b384-114c-4a4e-84a8-8f007f133b34" data-media-type="file"></span><ul><li><p>A 1% error between the calculated SOC and the number of laps completed will cause the controller to adjust the throttle by 6%</p></li><li><p>The controller will control the power output of the motor controllers</p><ul><li><p>Since Power = Torque*Speed, we want to limit the power so torque can happen which doesn’t take a lot of power at low speeds. That way later on we can limit the speed once the car reaches higher speeds.</p></li><li><p>We are able to set either power or torque limits for the motor controllers using the VCU</p></li></ul></li><li><p>The throttle map will scale down the values to a max of 30%</p></li></ul><h1 id="DesignNotes-ActionItems">Action Items</h1><ul class="inline-task-list" data-inline-tasks-content-id="42622517432"><li data-inline-task-id="1"><span class="placeholder-inline-tasks">Implement the controller</span></li><li data-inline-task-id="2"><span class="placeholder-inline-tasks">Design the throttle map</span></li><li data-inline-task-id="3"><span class="placeholder-inline-tasks">Add SOC% to the dash</span></li><li data-inline-task-id="4"><span class="placeholder-inline-tasks">Add buttons to start/stop and toggle the controller</span></li></ul><h1 id="DesignNotes-MyQuestions">My Questions</h1><ul><li><p><strong>Ask Calvin how the lap chip works and how it is triggered in code</strong></p></li><li><p><strong>Which buttons can we use? From vcu:</strong></p></li></ul><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/42622517432/42902913043.png" data-image-src="attachments/42622517432/42902913043.png" data-height="94" data-width="141" data-unresolved-comment-count="0" data-linked-resource-id="42902913043" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220125-090413.png" data-base-url="https://uwaterloo.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="42622517432" data-linked-resource-container-version="28" data-media-id="9d0a5149-3efa-4f09-a42f-533e430376af" data-media-type="file"></span><ul><li><p>The current values are transmitted in a uint16_t with a min of -512 and a max of 511.984375 with a step of 1/64 A (approx 15.6 mA)</p></li><li><p>What is dwell in the matlab script</p></li><li><p>How do we calibrate when its below the upper limit of our voltage threshold (56V)</p></li><li><p>Don’t think I did current limit properly on motor controllers bc the max for charge/discharge is set to 30A</p></li><li><p>Why does Error_I have error_P in its formula?</p></li></ul>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902552579.xls">filt_30Q_C5_endurance_sealed_3.12A_2020-09-14_data.xls</a> (application/vnd.ms-excel)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902454278">Points Calculation</a> (application/octet-stream)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902454286.png">image-20220125-090050.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42901995570.png">image-20220125-090054.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42901111543.png">image-20220125-090057.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42903044101.png">image-20220125-090059.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42903044112.png">image-20220125-090059.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902847495.png">image-20220125-090059.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902716427.png">image-20220125-090113.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42902913043.png">image-20220125-090413.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42910614372.png">image-20220127-022348.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42906059309.png">image-20220127-023845.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42905633318.png">image-20220127-022348.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/42622517432/42911302463.pdf">X2 CAN bus description.pdf</a> (application/pdf)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 01:33</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
