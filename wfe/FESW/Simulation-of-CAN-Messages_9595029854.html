<!DOCTYPE html>
<html>
    <head>
        <title>Firmware : Simulation of CAN Messages</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Firmware_9465365086.html">Firmware</a></span>
                            </li>
                                                    <li>
                                <span><a href="Documentation_9513894334.html">Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Board-Specific-Documentation_9567701653.html">Board Specific Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Beaglebone_9595029852.html">Beaglebone</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Firmware : Simulation of CAN Messages
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> zzakiull@uwaterloo.ca</span>, last modified on Mar 17, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>This document outlines how we can simulate CAN messages on the Beaglebone on our VM. It contains the following:</p><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1665797707587 {padding: 0px;}
div.rbtoc1665797707587 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1665797707587 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1665797707587'>
<ul class='toc-indentation'>
<li><a href='#SimulationofCANMessages-CreatingaSimulation'>Creating a Simulation</a>
<ul class='toc-indentation'>
<li><a href='#SimulationofCANMessages-DBCFile'>DBC File</a></li>
<li><a href='#SimulationofCANMessages-JSONFile'>JSON File</a></li>
</ul>
</li>
<li><a href='#SimulationofCANMessages-RunningaSimulation'>Running a Simulation</a>
<ul class='toc-indentation'>
<li><a href='#SimulationofCANMessages-CreatingtheVCANInterface'>Creating the VCAN Interface</a></li>
<li><a href='#SimulationofCANMessages-UsingtheCommandLineTool'>Using the Command Line Tool</a></li>
</ul>
</li>
<li><a href='#SimulationofCANMessages-FurtherReferences'>Further References</a></li>
</ul>
</div></p><h1 id="SimulationofCANMessages-CreatingaSimulation">Creating a Simulation</h1><p>What messages are sent during the simulation is dependent on the DBC and JSON file specified when invoking the simulation script.</p><p>Our default DBC file is found in <strong>common-all/Data/2018CAR.dbc</strong>. It contains all message names and signals that we would send to the bus. You won't have to make any changes to this file when running a simulation. However, you'll have to be able to read through it to determine what messages you want to specify in the JSON file.</p><p>The JSON file contains the specific names and signals we would like to send in our simulation. You'll have to create this file to run a custom simulation.</p><h2 id="SimulationofCANMessages-DBCFile">DBC File</h2><p>Below is a snippet of <strong>common-all/Data/2018CAR.dbc</strong>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">BO_ 2227830532 ChargeCart_Heartbeat: 8 ChargeCart
 SG_ ChargeCart_Heartbeat_dummydata : 0|1@1- (1,0) [0|0] &quot;&quot;  BMU

BO_ 2551190019 LV_Bus_Measurements: 4 PDU
 SG_ CurrentBusLV : 16|16@1+ (1,0) [0|0] &quot;mA&quot; Vector__XXX
 SG_ VoltageBusLV : 0|14@1+ (1,0) [0|16383] &quot;mV&quot; Vector__XXX</pre>
</div></div><p>There are 2 messages listed above. For the purposes of creating a JSON file, all that we'll need to get from this is the message name and signal(s). But here's some info about each message below:</p><div class="table-wrap"><table class="confluenceTable"><colgroup><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Frame ID</th><th class="confluenceTh">Message Name</th><th class="confluenceTh">Signals</th></tr><tr><td class="confluenceTd">2227830532</td><td class="confluenceTd">ChargeCart_Heartbeat</td><td class="confluenceTd">ChargeCart_Heartbeat_dummydata</td></tr><tr><td colspan="1" class="confluenceTd">2551190019</td><td colspan="1" class="confluenceTd">LV_Bus_Measurements</td><td colspan="1" class="confluenceTd"><p>CurrentBusLV</p><p>VoltageBusLV</p></td></tr></tbody></table></div><h2 id="SimulationofCANMessages-JSONFile">JSON File</h2><p>Using the 2 messages in the snippet of the DBC file above, we can create the following JSON file as an example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
    &quot;periodic_messages&quot;: [
         {
             &quot;name&quot;: &quot;ChargeCart_Heartbeat&quot;,
             &quot;signals&quot;:
              {
                  &quot;ChargeCart_Heartbeat_dummydata&quot;: 0
              },
              &quot;period_ms&quot;: 50,
              &quot;time&quot;: 1500
         },
         # repeat for any other periodic messages in the scenario
     ],
    &quot;one_time_messages&quot;: {
	 	{
			&quot;name&quot;: &quot;LV_Bus_Measurements&quot;,
			&quot;signals&quot;:
			{
				&quot;CurrentBusLV&quot;: 0,
				&quot;VoltageBusLV&quot;: 0
			},
			&quot;time&quot;: 1500
		},
		# repeat for any other one time messages in the scenario
	}
}</pre>
</div></div><p>You can specify messages to be sent periodically and messages to be sent only once. The &quot;time&quot; property specifies the starting time for the message to be sent, and the &quot;period_ms&quot; property (only applicable to period_messages) specifies how often the message is sent after the starting time.</p><p><strong>Note:</strong> All times are in milliseconds.</p><h1 id="SimulationofCANMessages-RunningaSimulation">Running a Simulation</h1><h2 id="SimulationofCANMessages-CreatingtheVCANInterface">Creating the VCAN Interface</h2><p>Before starting a simulation, we need to create the virtual CAN interface using SocketCAN. To do this, open a terminal and run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sudo modprobe can
sudo ip link add dev vcan0 type vcan
sudo ip link set up vcan0</pre>
</div></div><p>If you get an error message that says something like <strong>Modprobe: FATAL: Module vcan not found in directory</strong>, then run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sudo apt-get install linux-modules-extra-$(uname -r)</pre>
</div></div><p>and then try the first 3 commands above again.</p><h2 id="SimulationofCANMessages-UsingtheCommandLineTool">Using the Command Line Tool</h2><p>First, clone the 2020_beaglebone_app repository. You can clone it from your VM or your host computer depending on where you've <a class="external-link" href="https://wiki.uwaterloo.ca/display/FESW/.ssh+Key+Set+Up+-+BitBucket" rel="nofollow">set up your SSH key</a>, but you'll be running the simulator script in your VM. If you cloned the repo from your host computer, then make sure it's in the <strong>shared/</strong> directory so you can access it from your VM.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">git clone git@bitbucket.org:waterloohybrid/2020_beaglebone_app.git</pre>
</div></div><p>On your VM, open a terminal and go into the <strong>app/</strong> directory in 2020_beaglebone_app. Now you're in the same directory as the simulator script. To open a help menu for the simulator, run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">python3 can_simulator.py -h</pre>
</div></div><p>This will display:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">usage: can_simulator.py [-h] [-d DBC] [-j JSON] [-t TIME]

Run CAN Simulations with CAN monitor.

optional arguments:
  -h, --help            show this help message and exit
  -d DBC, --dbc DBC     DBC file (default: common-all/Data/2018CAR.dbc)
  -j JSON, --json JSON  JSON file (default: json/heartbeat.json)
  -t TIME, --time TIME  Duration of simulation in ms (default: 5000)</pre>
</div></div><p class="auto-cursor-target">For example, relative to the simulator script, your DBC file is found in <strong>dbc/car.dbc</strong> and your JSON file is found in <strong>json/scenario.json</strong>, and you'd like to run the simulation for 2.5 seconds, you would run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">python3 can_simulator.py -d dbc/car.dbc -j json/scenario.json -t 2500</pre>
</div></div><p class="auto-cursor-target">You can pick and choose what arguments you want to pass in. If you want to run a simulation using the default argument values, just run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">python3 can_simulator.py</pre>
</div></div><h1 class="auto-cursor-target" id="SimulationofCANMessages-FurtherReferences">Further References</h1><p>For further reference, you can look at these links:</p><ul><li><a class="external-link" href="https://python-can.readthedocs.io/en/master/index.html" rel="nofollow">python-can</a></li><li><a class="external-link" href="https://python-can.readthedocs.io/en/master/interfaces/socketcan.html" rel="nofollow">SocketCAN - python-can</a></li><li><a class="external-link" href="https://cantools.readthedocs.io/en/stable/index.html?highlight=encode_message" rel="nofollow">CAN BUS Tools</a></li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 15, 2022 01:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
